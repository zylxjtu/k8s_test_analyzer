services:
  k8s-test-analyzer:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        FASTMCP_PORT: ${FASTMCP_PORT:-8978}
    container_name: k8s-test-analyzer
    user: "${DOCKER_UID:-0}:${DOCKER_GID:-0}"  # Run as host user; defaults to root (0:0) if not specified
    network_mode: host  # Use host networking for better performance
    volumes:
      - ${PROJECTS_ROOT}:/projects
      - ${PROJECTS_ROOT}/container_cache:/app/.cache  # Cache folder (works for both root and non-root)
      - ./debugging_guides.yaml:/app/debugging_guides.yaml:ro  # Live-updatable debugging guides
    environment:
      - HOME=/app  # Set HOME for cache directory to work with any user
      - FASTMCP_PORT=${FASTMCP_PORT:-8978}
      - PROJECTS_ROOT=/projects
      - DEFAULT_DASHBOARD=${DEFAULT_DASHBOARD:-sig-windows-signal}
      - FOLDERS_TO_INDEX=${FOLDERS_TO_INDEX}  # Use env variable for folders
      - ADDITIONAL_IGNORE_DIRS=${ADDITIONAL_IGNORE_DIRS}  # Additional directories to ignore
      - ADDITIONAL_IGNORE_FILES=${ADDITIONAL_IGNORE_FILES}  # Additional files to ignore
      - SCHEDULE_INTERVAL_SECONDS=${SCHEDULE_INTERVAL_SECONDS:-1800}
      - CLEANUP_KEEP_BUILDS=${CLEANUP_KEEP_BUILDS:-10}
      - HEALTHCHECK_MAX_AGE=${HEALTHCHECK_MAX_AGE:-300}  # Heartbeat staleness threshold (seconds)
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
    healthcheck:
      test: ["CMD", "python", "healthcheck.py"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 180s  # Allow 3 minutes for initial startup/indexing
